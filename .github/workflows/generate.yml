name: Generate AdGuard Home Upstream DNS File

on:
  schedule:
    - cron: '0 0 */3 * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main 分支
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # 获取完整历史记录

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install requests
        run: pip install requests

      - name: 生成 upstream_dns.txt 和 README.md
        run: python scripts/generate_upstream.py

      - name: 配置 Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: 推送文件到 dev 分支
        run: |
          # 尝试切换到 dev 分支，如果不存在则从远程拉取
          if git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "远程 dev 分支存在，拉取并切换"
            git fetch origin dev:dev
            git checkout dev
            git pull origin dev
          else
            echo "远程 dev 分支不存在，创建本地 dev 分支"
            git checkout -b dev
          fi
          
          # 复制生成的文件到当前分支
          if [ -f ../upstream_dns.txt ]; then
            cp ../upstream_dns.txt . || true
          fi
          
          if [ -f ../README.md ]; then
            cp ../README.md . || true
          fi
          
          # 如果文件存在则添加
          if [ -f upstream_dns.txt ]; then
            git add upstream_dns.txt
          fi
          
          if [ -f README.md ]; then
            git add README.md
          fi
          
          # 检查是否有更改
          if ! git diff --cached --quiet; then
            git commit -m "Auto update: upstream_dns.txt and README.md $(date -u +'%Y-%m-%d %H:%M UTC')"
            echo "提交成功"
          else
            echo "没有更改，无需提交"
            exit 0
          fi
          
          # 强制推送（因为这是自动生成的文件，覆盖是安全的）
          echo "强制推送到远程 dev 分支..."
          git push -f origin dev
          echo "dev 分支更新成功！包含 upstream_dns.txt 和 README.md～"
          
      - name: Delete workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 2
