name: Generate AdGuard Home Upstream DNS File

on:
  schedule:
    - cron: '0 0 */3 * *'  # 每3天运行一次
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      # 第一步：拉取 main 分支（因为脚本在 main）
      - name: Checkout main 分支（源码分支）
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      # 第二步：切换到 dev 分支（如果不存在就创建）
      - name: 设置 dev 分支
        run: |
          git checkout -b dev || git checkout dev
          git pull origin dev || echo "dev 分支新建中"

      # 第三步：安装 Python 和依赖
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install requests
        run: pip install requests

      # 第四步：运行脚本生成文件（脚本路径在 main，所以直接跑）
      - name: 生成 upstream_dns.txt
        run: python scripts/generate_upstream.py

      # 第五步：只提交 upstream_dns.txt 到 dev 分支
      - name: 提交并推送至 dev 分支
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add upstream_dns.txt
          
          git commit -m "Auto update upstream_dns.txt $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "无变更"
          
          git push origin dev --force-with-lease

      # 可选：如果你还想让 main 的 README 显示统计，可以再加一步（下面注释了）
      - name: 更新 main 的 README 并推回 main
        run: |
          git checkout main
          git add README.md
          git commit -m "Update stats in README" || echo "无变更"
          git push origin main
