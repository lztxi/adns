name: grok Generate AdGuard Home Upstream DNS File

on:
  schedule:
    - cron: '0 0 */3 * *'  # 每3天运行一次
  workflow_dispatch:

permissions:
  contents: write   # 只需写权限

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev 分支
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: 如果是第一次运行，创建 dev 分支
        run: |
          if ! git rev-parse --verify dev >/dev/null 2>&1; then
            git checkout -b dev
            git push origin dev
          fi

      - name: 超级清理：删除所有旧文件，只保留必要结构
        run: |
          # 删除根目录下所有文件和文件夹（除了 .git）
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          
          # 重新创建必要文件夹
          mkdir -p scripts .github/workflows

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install requests
        run: pip install requests

      - name: 重新添加脚本和 workflow 文件
        run: |
          # 这里假设你已经把最新脚本和 workflow 提交到仓库了
          # Actions 会从远程拉取最新代码，所以不用手动复制

      - name: 运行生成脚本（生成 upstream_dns.txt + 更新 README.md）
        run: python scripts/generate_upstream.py

      - name: 提交并强制推送（保持分支干净）
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add upstream_dns.txt README.md scripts/generate_upstream.py .github/workflows/generate.yml
          
          git commit -m "Auto clean & update: $(date -u +'%Y-%m-%d %H:%M UTC')" || echo "无变更"
          
          git push origin dev --force-with-lease
